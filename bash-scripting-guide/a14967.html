<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
    <meta
     name="generator"
     content=
    "HTML Tidy for Linux/x86 (vers 1st July 2002), see www.w3.org">

    <title>Подробное введение в операции ввода-вывода и перенаправление
    ввода-вывода</title>
    
    <meta
     name="GENERATOR"
     content="Modular DocBook HTML Stylesheet Version 1.7">
    <link
     rel="HOME"
     title="Advanced Bash-Scripting Guide"
     href="index.html">
    <link
     rel="PREVIOUS"
     title="Коды завершения, имеющие предопределенный смысл"
     href="a14876.html">
    <link
     rel="NEXT"
     title="Локализация"
     href="a15021.html">
  </head>

  <body bgcolor="#DDE1C2"><b><a href="http://www.opennet.ru/docs/">Архив документации OpenNet.ru</a> / 
Раздел "<a href="http://www.opennet.ru/docs/124.shtml">Программирование, языки</a>" /
<a href="index.html">Индекс</a>
</b>
<hr noshade size=1>

    <div
     class="NAVHEADER">
      <table
       summary="Header navigation table"
       width="100%"
       border="0"
       cellpadding="0"
       cellspacing="0">
        <tr>
          <th
           colspan="3"
           align="center">Advanced Bash-Scripting Guide: Искусство
          программирования на языке сценариев командной оболочки</th>
        </tr>

        <tr>
          <td
           width="10%"
           align="left"
           valign="bottom"><a
           href="a14876.html"
           accesskey="P">Назад</a></td>

          <td
           width="80%"
           align="center"
           valign="bottom">
          </td>

          <td
           width="10%"
           align="right"
           valign="bottom"><a
           href="a15021.html"
           accesskey="N">Вперед</a></td>
        </tr>
      </table>
      <hr
       align="left"
       width="100%">
    </div>

    <div
     class="APPENDIX">
      <h1><a
       name="IOREDIRINTRO"></a>Приложение D. Подробное введение в
      операции ввода-вывода и перенаправление ввода-вывода</h1>

      <p><span
       class="emphasis"><em
       class="EMPHASIS">написано Stephane Chazelas и дополнено автором
      документа</em></span></p>

      <p>Практически любая команда предполагает доступность 3-х <a
       href="c11620.html#FDREF">файловых дескрипторов</a>. Первый --
      <span
       class="emphasis"><em
       class="EMPHASIS">0</em></span> (стандвртный ввод, <tt
       class="FILENAME">stdin</tt>), доступный для чтения. И два других
      -- <span
       class="emphasis"><em
       class="EMPHASIS">1</em></span> (<tt
       class="FILENAME">stdout</tt>) и <span
       class="emphasis"><em
       class="EMPHASIS">2</em></span> (<tt
       class="FILENAME">stderr</tt>), доступные для записи.</p>

      <p>Запись, типа <tt
       class="USERINPUT"><strong>ls 2&gt;&amp;1</strong></tt>, означает
      временное перенаправление вывода, с устройства <tt
       class="FILENAME">stderr</tt> на устройство <tt
       class="FILENAME">stdout</tt>.</p>

      <p>В соответствии с соглашениями, команды принимают ввод из файла
      с дескриптором 0 (<tt
       class="FILENAME">stdin</tt>), выводят результат работы в файл с
      дескриптором 1 (<tt
       class="FILENAME">stdout</tt>), а сообщения об ошибках -- в файл
      с дескриптором 2 (<tt
       class="FILENAME">stderr</tt>). Если какой либо из этих трех
      дескрипторов окажется закрытым, то могут возникнуть определенные
      проблемы:</p>
<pre
 class="SCREEN">
<tt
 class="PROMPT">bash$</tt> <tt
 class="USERINPUT"><strong>cat /etc/passwd &gt;&amp;-</strong></tt>
<tt
 class="COMPUTEROUTPUT">cat: standard output: Bad file descriptor</tt>
     
</pre>

      <p>К примеру, когда пользователь запускает <strong
       class="COMMAND">xterm</strong>, то он сначала выполняет
      процедуру инициализации, а затем, перед запуском командной
      оболочки, <strong
       class="COMMAND">xterm</strong> трижды открывает терминальные
      устройства (/dev/pts/&lt;n&gt;, или нечто подобное).</p>

      <p>После этого, командная оболочка наследует эти три дескриптора,
      и любая команда, запускаемая в этой оболочке, так же наследует
      их. Термин <a
       href="c11620.html#IOREDIRREF">перенаправление</a> -- означает
      переназначение одного файлового дескриптора на другой (канал
      (конвейер) или что-то другое). Переназначение может быть
      выполнено локально (для отдельной команды, для группы команд, для
      подоболочки, для операторов <a
       href="x11731.html#REDIRREF">while, if, case, for</a>...) или
      глобально (с помощью <a
       href="c5358.html#EXECREF">exec</a>).</p>

      <p><tt
       class="USERINPUT"><strong>ls &gt; /dev/null</strong></tt> --
      означает запуск команды <strong
       class="COMMAND">ls</strong> с файловым дескриптором 1,
      присоединенным к устройству <tt
       class="FILENAME">/dev/null</tt>.</p>
<pre
 class="SCREEN">
<tt
 class="PROMPT">bash$</tt> <tt
 class="USERINPUT"><strong>lsof -a -p $$ -d0,1,2</strong></tt>
<tt
 class=
"COMPUTEROUTPUT">COMMAND PID     USER   FD   TYPE DEVICE SIZE NODE NAME
 bash    363 bozo        0u   CHR  136,1         3 /dev/pts/1
 bash    363 bozo        1u   CHR  136,1         3 /dev/pts/1
 bash    363 bozo        2u   CHR  136,1         3 /dev/pts/1</tt>


<tt
 class="PROMPT">bash$</tt> <tt
 class="USERINPUT"><strong>exec 2&gt; /dev/null</strong></tt>
<tt
 class="PROMPT">bash$</tt> <tt
 class="USERINPUT"><strong>lsof -a -p $$ -d0,1,2</strong></tt>
<tt
 class=
"COMPUTEROUTPUT">COMMAND PID     USER   FD   TYPE DEVICE SIZE NODE NAME
 bash    371 bozo        0u   CHR  136,1         3 /dev/pts/1
 bash    371 bozo        1u   CHR  136,1         3 /dev/pts/1
 bash    371 bozo        2w   CHR    1,3       120 /dev/null</tt>


<tt
 class="PROMPT">bash$</tt> <tt
 class=
"USERINPUT"><strong>bash -c &#39;lsof -a -p $$ -d0,1,2&#39; | cat</strong></tt>
<tt
 class=
"COMPUTEROUTPUT">COMMAND PID USER   FD   TYPE DEVICE SIZE NODE NAME
 lsof    379 root    0u   CHR  136,1         3 /dev/pts/1
 lsof    379 root    1w  FIFO    0,0      7118 pipe
 lsof    379 root    2u   CHR  136,1         3 /dev/pts/1</tt>


<tt
 class="PROMPT">bash$</tt> <tt
 class=
"USERINPUT"><strong>echo &quot;$(bash -c &#39;lsof -a -p $$ -d0,1,2&#39; 2&gt;&amp;1)&quot;</strong></tt>
<tt
 class=
"COMPUTEROUTPUT">COMMAND PID USER   FD   TYPE DEVICE SIZE NODE NAME
 lsof    426 root    0u   CHR  136,1         3 /dev/pts/1
 lsof    426 root    1w  FIFO    0,0      7520 pipe
 lsof    426 root    2w  FIFO    0,0      7520 pipe</tt>
</pre>
      <br>
      <br>

      <p><tt
       class="USERINPUT"><strong>Упражнение:</strong></tt>
      Проанализируйте следующий сценарий.</p>
<pre
 class="PROGRAMLISTING">
#! /usr/bin/env bash

mkfifo /tmp/fifo1 /tmp/fifo2
while read a; do echo &quot;FIFO1: $a&quot;; done &lt; /tmp/fifo1 &amp;
exec 7&gt; /tmp/fifo1
exec 8&gt; &gt;(while read a; do echo &quot;FD8: $a, to fd7&quot;; done &gt;&amp;7)

exec 3&gt;&amp;1
(
 (
  (
   while read a; do echo &quot;FIFO2: $a&quot;; done &lt; /tmp/fifo2 | tee /dev/stderr | tee /dev/fd/4 | tee /dev/fd/5 | tee /dev/fd/6 &gt;&amp;7 &amp;
   exec 3&gt; /tmp/fifo2

   echo 1st, to stdout
   sleep 1
   echo 2nd, to stderr &gt;&amp;2
   sleep 1
   echo 3rd, to fd 3 &gt;&amp;3
   sleep 1
   echo 4th, to fd 4 &gt;&amp;4
   sleep 1
   echo 5th, to fd 5 &gt;&amp;5
   sleep 1                                                                                              
   echo 6th, through a pipe | sed &#39;s/.*/PIPE: &amp;, to fd 5/&#39; &gt;&amp;5                                          
   sleep 1                                                                                              
   echo 7th, to fd 6 &gt;&amp;6                                                                                
   sleep 1                                                                                              
   echo 8th, to fd 7 &gt;&amp;7
   sleep 1                                                                                              
   echo 9th, to fd 8 &gt;&amp;8                                                                                
                                                                                                        
  ) 4&gt;&amp;1 &gt;&amp;3 3&gt;&amp;- | while read a; do echo &quot;FD4: $a&quot;; done 1&gt;&amp;3 5&gt;&amp;- 6&gt;&amp;-                                
 ) 5&gt;&amp;1 &gt;&amp;3 | while read a; do echo &quot;FD5: $a&quot;; done 1&gt;&amp;3 6&gt;&amp;-
) 6&gt;&amp;1 &gt;&amp;3 | while read a; do echo &quot;FD6: $a&quot;; done 3&gt;&amp;-                                                 
                                                                                                        
rm -f /tmp/fifo1 /tmp/fifo2


# Выясните, куда переназначены файловые дескрипторы каждой команды и подоболочки.

exit 0
</pre>
      <br>
      <br>
    </div>

    <div
     class="NAVFOOTER">
      <hr
       align="left"
       width="100%">

      <table
       summary="Footer navigation table"
       width="100%"
       border="0"
       cellpadding="0"
       cellspacing="0">
        <tr>
          <td
           width="33%"
           align="left"
           valign="top"><a
           href="a14876.html"
           accesskey="P">Назад</a></td>

          <td
           width="34%"
           align="center"
           valign="top"><a
           href="index.html"
           accesskey="H">К началу</a></td>

          <td
           width="33%"
           align="right"
           valign="top"><a
           href="a15021.html"
           accesskey="N">Вперед</a></td>
        </tr>

        <tr>
          <td
           width="33%"
           align="left"
           valign="top">Коды завершения, имеющие предопределенный
          смысл</td>

          <td
           width="34%"
           align="center"
           valign="top"> </td>

          <td
           width="33%"
           align="right"
           valign="top">Локализация</td>
        </tr>
      </table>
    </div>
  <hr noshade size=1>
<b><a href="http://www.opennet.ru/docs/">Архив документации на OpenNet.ru</a>
</body>
</html>

