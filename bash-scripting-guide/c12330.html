<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=koi8-r">
    <meta
     name="generator"
     content=
    "HTML Tidy for Linux/x86 (vers 1st July 2002), see www.w3.org">

    <title>Подоболочки, или Subshells</title>
    
    <meta
     name="GENERATOR"
     content="Modular DocBook HTML Stylesheet Version 1.7">
    <link
     rel="HOME"
     title="Advanced Bash-Scripting Guide"
     href="index.html">
    <link
     rel="UP"
     title="Материал повышенной сложности"
     href="p11889.html">
    <link
     rel="PREVIOUS"
     title="Globbing -- Подстановка имен файлов"
     href="x12282.html">
    <link
     rel="NEXT"
     title="Ограниченный режим командной оболочки"
     href="c12376.html">
  </head>

  <body bgcolor="#DDE1C2"><b><a href="http://www.opennet.ru/docs/">Архив документации OpenNet.ru</a> / 
Раздел "<a href="http://www.opennet.ru/docs/124.shtml">Программирование, языки</a>" /
<a href="index.html">Индекс</a>
</b>
<hr noshade size=1>

    <div
     class="NAVHEADER">
      <table
       summary="Header navigation table"
       width="100%"
       border="0"
       cellpadding="0"
       cellspacing="0">
        <tr>
          <th
           colspan="3"
           align="center">Advanced Bash-Scripting Guide: Искусство
          программирования на языке сценариев командной оболочки</th>
        </tr>

        <tr>
          <td
           width="10%"
           align="left"
           valign="bottom"><a
           href="x12282.html"
           accesskey="P">Назад</a></td>

          <td
           width="80%"
           align="center"
           valign="bottom">
          </td>

          <td
           width="10%"
           align="right"
           valign="bottom"><a
           href="c12376.html"
           accesskey="N">Вперед</a></td>
        </tr>
      </table>
      <hr
       align="left"
       width="100%">
    </div>

    <div
     class="CHAPTER">
      <h1><a
       name="SUBSHELLS"></a>Глава 19. Подоболочки, или Subshells</h1>

      <p><a
       name="SUBSHELLSREF"></a></p>

      <p>Запуск сценария приводит к запуску дочернего командного
      интерпретатора. Который выполняет интерпретацию и исполнение
      списка команд, содержащихся в файле сценария, точно так же, как
      если бы они были введены из командной строки. Любой сценарий
      запускается как дочерний процесс <a
       href="c5358.html#FORKREF">родительской</a> командной оболочки,
      той самой, которая выводит перед вами строку приглашения к вводу
      на консоли или в окне xterm.</p>

      <p>Сценарий может, так же, запустить другой дочерний процесс, в
      своей подоболочке. Это позволяет сценариям распараллелить процесс
      обработки данных по нескольким задачам, исполняемым
      одновременно.</p>

      <div
       class="VARIABLELIST">
        <p><strong><a
         name="SUBSHELLPARENS1"></a>Список команд в круглых
        скобках</strong></p>

        <dl>
          <dt>( command1; command2; command3; ... )</dt>

          <dd>
            <p>Список команд, в круглых скобках, исполняется в
            подоболочке.</p>
          </dd>
        </dl>
      </div>

      <div
       class="NOTE">
        <table
         class="NOTE"
         width="100%"
         border="0">
          <tr>
            <td
             width="25"
             align="center"
             valign="top"><img
             src="misc/abs-book/images/note.gif"
             hspace="5"
             alt="Note"></td>

            <td
             align="left"
             valign="top">
              <p><a
               name="PARVIS"></a>Значения переменных, определенных в
              дочерней оболочке, <span
               class="emphasis"><em
               class="EMPHASIS">не</em></span> могут быть переданы
              родительской оболочке. Они недоступны <a
               href="c5358.html#FORKREF">родительскому процессу</a>.
              Фактически, они ведут себя как <a
               href="x12644.html">локальные переменные</a>.</p>
            </td>
          </tr>
        </table>
      </div>

      <div
       class="EXAMPLE">
        <a
         name="SUBSHELL"></a>

        <p><strong>Пример 19-1. Область видимости
        переменных</strong></p>
<pre
 class="PROGRAMLISTING">
#!/bin/bash
# subshell.sh

echo

outer_variable=Outer

(
inner_variable=Inner
echo &quot;Дочерний процесс, \&quot;inner_variable\&quot; = $inner_variable&quot;
echo &quot;Дочерний процесс, \&quot;outer\&quot; = $outer_variable&quot;
)

echo

if [ -z &quot;$inner_variable&quot; ]
then
  echo &quot;Переменная inner_variable не определена в родительской оболочке&quot;
else
  echo &quot;Переменная inner_variable определена в родительской оболочке&quot;
fi

echo &quot;Родительский процесс, \&quot;inner_variable\&quot; = $inner_variable&quot;
# Переменная $inner_variable не будет определена
# потому, что переменные, определенные в дочернем процессе,
# ведут себя как &quot;локальные переменные&quot;.

echo

exit 0
</pre>
      </div>

      <p>См. также <a
       href="c13371.html#SUBPIT">Пример 31-1</a>.</p>

      <p>+</p>

      <p>Смена текущего каталога в дочернем процессе (подоболочке) не
      влечет за собой смену текущего каталога в родительской
      оболочке.</p>

      <div
       class="EXAMPLE">
        <a
         name="ALLPROFS"></a>

        <p><strong>Пример 19-2. Личные настройки
        пользователей</strong></p>
<pre
 class="PROGRAMLISTING">
#!/bin/bash
# allprofs.sh: вывод личных настроек (profiles) всех пользователей

# Автор: Heiner Steven
# С некоторыми изменениями, внесенными автором документа.

FILE=.bashrc  #  Файл настроек пользователя,
              #+ в оригинальном сценарии называется &quot;.profile&quot;.

for home in `awk -F: &#39;{print $6}&#39; /etc/passwd`
do
  [ -d &quot;$home&quot; ] || continue    # Перейти к следующей итерации, если нет домашнего каталога.
  [ -r &quot;$home&quot; ] || continue    # Перейти к следующей итерации, если не доступен для чтения.
  (cd $home; [ -e $FILE ] &amp;&amp; less $FILE)
done

#  По завершении сценария -- нет теобходимости выполнять команду &#39;cd&#39;, чтобы вернуться в первоначальный каталог,
#+ поскольку &#39;cd $home&#39; выполняется в подоболочке.

exit 0
</pre>
      </div>

      <p>Подоболочка может использоваться для задания <span
       class="QUOTE">&quot;специфического окружения&quot;</span> для
      группы команд.</p>
<pre
 class="PROGRAMLISTING">
COMMAND1
COMMAND2
COMMAND3
(
  IFS=:
  PATH=/bin
  unset TERMINFO
  set -C
  shift 5
  COMMAND4
  COMMAND5
  exit 3 # Выход только из подоболочки.
)
# Изменение переменных окружения не коснется родительской оболочки.
COMMAND6
COMMAND7
</pre>
      Как вариант использования подоболочки -- проверка переменных. 
<pre
 class="PROGRAMLISTING">
if (set -u; : $variable) 2&gt; /dev/null
then
  echo &quot;Переменная определена.&quot;
fi

# Можно сделать то же самое по другому: [[ ${variable-x} != x || ${variable-y} != y ]]
# или                                   [[ ${variable-x} != x$variable ]]
# или                                   [[ ${variable+x} = x ]])
</pre>
      Еще одно применение -- проверка файлов блокировки: 
<pre
 class="PROGRAMLISTING">
if (set -C; : &gt; lock_file) 2&gt; /dev/null
then
  echo &quot;Этот сценарий уже запущен другим пользователем.&quot;
  exit 65
fi

# Спасибо S.C.
</pre>
      <br>
      <br>

      <p>Процессы в подоболочках могут исполняться параллельно. Это
      позволяет разбить сложную задачу на несколько простых подзадач,
      выполняющих параллельную обработку информации.</p>

      <div
       class="EXAMPLE">
        <a
         name="PARALLEL-PROCESSES"></a>

        <p><strong>Пример 19-3. Запуск нескольких процессов в
        подоболочках</strong></p>
<pre
 class="PROGRAMLISTING">
       (cat list1 list2 list3 | sort | uniq &gt; list123) &amp;
        (cat list4 list5 list6 | sort | uniq &gt; list456) &amp;
        # Слияние и сортировка двух списков производится одновременно.
        # Запуск в фоне гарантирует параллельное исполнение.
        #
        # Тот же эффект дает
        #   cat list1 list2 list3 | sort | uniq &gt; list123 &amp;
        #   cat list4 list5 list6 | sort | uniq &gt; list456 &amp;

        wait   # Ожидание завершения работы подоболочек.

        diff list123 list456
</pre>
      </div>

      <p>Перенаправление ввода/вывода в/из подоболочки производится
      оператором построения конвейера <span
       class="QUOTE">&quot;|&quot;</span>, например, <tt
       class="USERINPUT"><strong>ls -al | (command)</strong></tt>.</p>

      <div
       class="NOTE">
        <table
         class="NOTE"
         width="100%"
         border="0">
          <tr>
            <td
             width="25"
             align="center"
             valign="top"><img
             src="misc/abs-book/images/note.gif"
             hspace="5"
             alt="Note"></td>

            <td
             align="left"
             valign="top">
              <p>Блок команд, заключенный в <tt
               class="REPLACEABLE"><em>фигурные скобки</em></tt> не
              приводит к запуску дочерней подоболочки.</p>

              <p>{ command1; command2; command3; ... }</p>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div
     class="NAVFOOTER">
      <hr
       align="left"
       width="100%">

      <table
       summary="Footer navigation table"
       width="100%"
       border="0"
       cellpadding="0"
       cellspacing="0">
        <tr>
          <td
           width="33%"
           align="left"
           valign="top"><a
           href="x12282.html"
           accesskey="P">Назад</a></td>

          <td
           width="34%"
           align="center"
           valign="top"><a
           href="index.html"
           accesskey="H">К началу</a></td>

          <td
           width="33%"
           align="right"
           valign="top"><a
           href="c12376.html"
           accesskey="N">Вперед</a></td>
        </tr>

        <tr>
          <td
           width="33%"
           align="left"
           valign="top">Globbing -- Подстановка имен файлов</td>

          <td
           width="34%"
           align="center"
           valign="top"><a
           href="p11889.html"
           accesskey="U">Наверх</a></td>

          <td
           width="33%"
           align="right"
           valign="top">Ограниченный режим командной оболочки</td>
        </tr>
      </table>
    </div>
  <hr noshade size=1>
<b><a href="http://www.opennet.ru/docs/">Архив документации на OpenNet.ru</a>
</body>
</html>

